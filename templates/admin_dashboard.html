{% extends "base.html" %}

{% block title %}Admin Dashboard - Vehicle Parking System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h2>
        <p class="text-muted">Manage parking lots and monitor system activity</p>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ lots|length }}</h4>
                        <p class="mb-0">Total Parking Lots</p>
                    </div>
                    <div>
                        <i class="fas fa-building fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ total_users }}</h4>
                        <p class="mb-0">Registered Users</p>
                    </div>
                    <div>
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ active_reservations }}</h4>
                        <p class="mb-0">Active Reservations</p>
                    </div>
                    <div>
                        <i class="fas fa-car fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="row mb-4">
    <div class="col-12">
        <a href="{{ url_for('create_lot') }}" class="btn btn-primary me-2">
            <i class="fas fa-plus"></i> Add New Parking Lot
        </a>
        <a href="{{ url_for('view_users') }}" class="btn btn-info">
            <i class="fas fa-users"></i> View All Users
        </a>
    </div>
</div>

<!-- Parking Lots Management -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-building"></i> Parking Lots Management</h5>
            </div>
            <div class="card-body">
                {% if lots %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Location Name</th>
                                    <th>Address</th>
                                    <th>Pin Code</th>
                                    <th>Price/Hour</th>
                                    <th>Total Spots</th>
                                    <th>Available</th>
                                    <th>Occupied</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lot in lots %}
                                <tr>
                                    <td>{{ lot.id }}</td>
                                    <td>{{ lot.prime_location_name }}</td>
                                    <td>{{ lot.address }}</td>
                                    <td>{{ lot.pin_code }}</td>
                                    <td>â‚¹{{ lot.price }}</td>
                                    <td>{{ lot.total_spots or 0 }}</td>
                                    <td><span class="status-available">{{ lot.available_spots or 0 }}</span></td>
                                    <td><span class="status-occupied">{{ lot.occupied_spots or 0 }}</span></td>
                                    <td>
                                        <a href="{{ url_for('edit_lot', lot_id=lot.id) }}" class="btn btn-sm btn-warning">
                                            <i class="fas fa-edit"></i> Edit
                                        </a>
                                        {% if lot.occupied_spots == 0 %}
                                            <a href="{{ url_for('delete_lot', lot_id=lot.id) }}" 
                                               class="btn btn-sm btn-danger"
                                               onclick="return confirm('Are you sure you want to delete this parking lot?')">
                                                <i class="fas fa-trash"></i> Delete
                                            </a>
                                        {% else %}
                                            <button class="btn btn-sm btn-secondary" disabled>
                                                <i class="fas fa-ban"></i> Can't Delete
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-building fa-3x text-muted mb-3"></i>
                        <h5>No Parking Lots Found</h5>
                        <p class="text-muted">Create your first parking lot to get started</p>
                        <a href="{{ url_for('create_lot') }}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add New Parking Lot
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Parking Lots Overview</h5>
            </div>
            <div class="card-body">
                <canvas id="parkingChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie"></i> Occupancy Status</h5>
            </div>
            <div class="card-body">
                <canvas id="occupancyChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Fetch parking data
    fetch('/api/parking_data')
        .then(response => response.json())
        .then(data => {
            // Parking Lots Chart
            const parkingCtx = document.getElementById('parkingChart').getContext('2d');
            new Chart(parkingCtx, {
                type: 'bar',
                data: {
                    labels: data.map(lot => lot.name),
                    datasets: [
                        {
                            label: 'Available',
                            data: data.map(lot => lot.available),
                            backgroundColor: '#28a745'
                        },
                        {
                            label: 'Occupied',
                            data: data.map(lot => lot.occupied),
                            backgroundColor: '#dc3545'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true }
                    }
                }
            });

            // Occupancy Pie Chart
            const totalAvailable = data.reduce((sum, lot) => sum + lot.available, 0);
            const totalOccupied = data.reduce((sum, lot) => sum + lot.occupied, 0);
            
            const occupancyCtx = document.getElementById('occupancyChart').getContext('2d');
            new Chart(occupancyCtx, {
                type: 'pie',
                data: {
                    labels: ['Available', 'Occupied'],
                    datasets: [{
                        data: [totalAvailable, totalOccupied],
                        backgroundColor: ['#28a745', '#dc3545']
                    }]
                },
                options: {
                    responsive: true
                }
            });
        })
        .catch(error => console.error('Error fetching parking data:', error));
});
</script>
{% endblock %}